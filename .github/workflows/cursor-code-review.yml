name: Cursor Code Review

on:
    pull_request:
        types: [opened, synchronize, reopened, ready_for_review]
    workflow_dispatch:
        inputs:
            pr_number:
                description: "PR number to review (for manual dispatch)"
                required: true
                type: number

jobs:
    code-review:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            pull-requests: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  ref: ${{ github.event_name == 'workflow_dispatch' && format('refs/pull/{0}/head', inputs.pr_number) || github.event.pull_request.head.sha }}

            - name: Install Cursor CLI
              run: |
                  curl https://cursor.com/install -fsS | bash
                  echo "$HOME/.cursor/bin" >> $GITHUB_PATH
                  echo 'PATH="$HOME/.cursor/bin:$PATH"' >> $GITHUB_ENV

            - name: Perform code review
              env:
                  CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
                  GH_TOKEN: ${{ github.token }}
              run: |
                  export PATH="$HOME/.cursor/bin:$PATH"
                  PR_NUM="${{ github.event_name == 'workflow_dispatch' && inputs.pr_number || github.event.pull_request.number }}"

                  agent --force --model claude-4-sonnet --output-format=text --print "You are operating in a GitHub Actions runner performing automated code review. The gh CLI is available and authenticated via GH_TOKEN. You may comment on pull requests.

                  Context:
                  - Repo: ${{ github.repository }}
                  - PR Number: ${PR_NUM}

                  Objectives:
                  1) Re-check existing review comments and reply resolved when addressed
                  2) Review the current PR diff and flag only clear, high-severity issues
                  3) Leave very short inline comments (1-2 sentences) on changed lines only and a brief summary at the end

                  Procedure:
                  - Get existing comments: gh pr view ${PR_NUM} --json comments
                  - Get diff: gh pr diff ${PR_NUM}
                  - If a previously reported issue appears fixed by nearby changes, reply: ‚úÖ This issue appears to be resolved by the recent changes
                  - Avoid duplicates: skip if similar feedback already exists on or near the same lines

                  Commenting rules:
                  - Max 10 inline comments total; prioritize the most critical issues
                  - One issue per comment; place on the exact changed line
                  - Natural tone, specific and actionable; do not mention automated or high-confidence
                  - Use emojis: üö® Critical üîí Security ‚ö° Performance ‚ö†Ô∏è Logic ‚úÖ Resolved ‚ú® Improvement

                  Submission:
                  - Submit one review containing inline comments plus a concise summary
                  - Use only: gh pr review ${PR_NUM} --comment
                  - Do not use: gh pr review --approve or --request-changes"
